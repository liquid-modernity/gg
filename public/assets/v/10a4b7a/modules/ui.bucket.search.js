(function(w){'use strict';var GG=w.GG=w.GG||{};GG.modules=GG.modules||{};GG.__uiBuckets=GG.__uiBuckets||{};if(GG.__uiBuckets.search)return;GG.__uiBuckets.search=true;(function(GG,w,d){'use strict';if(!GG)return;GG.modules=GG.modules||{};GG.modules.search=GG.modules.search||(function(){var S={i:[],r:0,p:null,u:null,o:0,a:-1,res:[],t:0,f:null,b:0,initd:0};var RK='gg_recents',PID='gg-search-panel';function TX(v){return String(v||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();}function AL(en){var l=en&&en.link?en.link:[];for(var i=0;i<l.length;i++)if(l[i].rel==='alternate'&&l[i].href)return l[i].href;return'';}function FM(json){var en=json&&json.feed&&json.feed.entry?json.feed.entry:[],out=[];for(var i=0;i<en.length;i++){var e=en[i]||{},t=e.title&&e.title.$t?e.title.$t:'',u=AL(e),s='';if(e.summary&&e.summary.$t)s=e.summary.$t;else if(e.content&&e.content.$t)s=e.content.$t;s=TX(s);if(s.length>160)s=s.slice(0,160);var labs='';if(e.category&&e.category.length){var a=[];for(var c=0;c<e.category.length;c++){var m=e.category[c]&&e.category[c].term;if(m)a.push(m);}if(a.length)labs=a.join(',').toLowerCase();}if(t&&u)out.push({title:t,url:u,labels:labs,t:t.toLowerCase(),s:s.toLowerCase()});}return out;}function IX(){if(S.r)return Promise.resolve(S.i);if(S.p)return S.p;S.p=LI().finally(function(){S.p=null;});return S.p;}async function LI(){if(!GG.services||!GG.services.api||!GG.services.api.getFeed)throw 0;var j=await GG.services.api.getFeed({summary:1,'max-results':500});S.i=FM(j);S.r=1;return S.i;}function EH(v){return String(v||'').replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);});}function UI(){var ui=S.u;if(ui&&ui.input)return ui;var dock=d.querySelector('#gg-dock .gg-dock__search');if(!dock)return null;var input=dock.querySelector('input[type="search"]');if(!input)return null;var close=dock.querySelector('[data-gg-dock-close]');var form=dock.querySelector('form');var panel=d.getElementById(PID);if(!panel){panel=d.createElement('div');panel.id=PID;panel.className='gg-search-panel';panel.setAttribute('role','listbox');panel.setAttribute('aria-label','S');panel.setAttribute('data-mode','center');panel.setAttribute('aria-hidden','true');panel.hidden=true;(d.body||d.documentElement).appendChild(panel);}S.u={dock:dock,input:input,close:close,form:form,panel:panel};input.setAttribute('aria-controls',PID);if(!S.b){S.b=1;input.addEventListener('input',function(){if(S.t)clearTimeout(S.t);if(!S.o)O(0);S.t=w.setTimeout(R,100);Y();});input.addEventListener('keydown',IK);input.addEventListener('focus',function(){O(1);});input.addEventListener('blur',function(){setTimeout(Y,120);});panel.addEventListener('click',function(e){var it=e.target&&e.target.closest?e.target.closest('.gg-search-item'):null;if(!it)return;e.preventDefault();NI(PI(it));});d.addEventListener('pointerdown',OD,true);if(close)close.addEventListener('click',function(){X();});if(form)form.addEventListener('submit',function(e){if(S.a>-1&&S.res&&S.res[S.a]){e.preventDefault();NI(S.res[S.a]);return;}e.preventDefault();FS();});w.addEventListener('resize',PP);if(w.visualViewport&&w.visualViewport.addEventListener)w.visualViewport.addEventListener('resize',PP);w.addEventListener('gg:search-open',function(){w.__ggHotkeySearchPending=0;w.__GG_PENDING_SEARCH=false;O(1);});}return S.u;}function FD(ui){if(!ui||!ui.input)return;var i=ui.input,n=0,rt=[0,50,100];function f(){try{i.focus({preventScroll:true});}catch(_){try{i.focus();}catch(__){}}if(d.activeElement===i||n>=rt.length)return;w.setTimeout(f,rt[n++]);}if(w.requestAnimationFrame)w.requestAnimationFrame(f);else f();}function DS(on){var k=d.querySelector('nav.gg-dock'),s=k&&k.getAttribute('data-gg-state')||'';if(!k)return;if(on){if((' '+s+' ').indexOf(' search ')<0)k.setAttribute('data-gg-state',(s+' search').trim());}else if(s.indexOf('search')>-1){s=(' '+s+' ').replace(' search ',' ').trim();s?k.setAttribute('data-gg-state',s):k.removeAttribute('data-gg-state');}}function E(e,q){var sr=GG.modules&&GG.modules.searchRank;sr&&sr.e&&sr.e(w,d,S,q,e);}function Y(){var ui=UI();if(!ui)return;var ae=d.activeElement,p=!!(ae&&(ui.dock.contains(ae)||ui.panel.contains(ae)));var keep=S.o||p||!!(ui.input&&ui.input.value&&ui.input.value.trim());DS(keep);}function VIS(el){if(!el||el.hasAttribute('hidden'))return 0;var r=el.getBoundingClientRect();return !!(r&&r.width>0&&r.height>0);}function AP(panel,ui){if(!panel||!ui)return;var a=ui.input||ui.dock;if(!VIS(a)){panel.setAttribute('data-mode','center');return;}var r=a.getBoundingClientRect();var vw=Math.max(320,(w.innerWidth||d.documentElement.clientWidth||0));var pw=Math.min(720,Math.max(220,Math.min(r.width,vw-24)));panel.style.setProperty('--gg-anchor-x',r.left+'px');panel.style.setProperty('--gg-anchor-y',r.top+'px');panel.style.setProperty('--gg-anchor-w',r.width+'px');panel.style.setProperty('--gg-anchor-h',r.height+'px');panel.style.setProperty('--gg-panel-w',pw+'px');panel.setAttribute('data-mode','dock');}function PP(){if(!S.o)return;var ui=UI();if(!ui)return;AP(ui.panel,ui);}function GR(){try{var v=localStorage.getItem(RK);if(v){var a=JSON.parse(v);if(Array.isArray(a))return a;}}catch(_){}return [];}function SR(url,title){if(!url||!title)return;var a=GR();for(var i=0;i<a.length;i++)if(a[i]&&a[i].url===url){a.splice(i,1);break;}a.unshift({url:url,title:title,ts:Date.now()});if(a.length>20)a.length=20;try{localStorage.setItem(RK,JSON.stringify(a));}catch(_){};}function MT(it){if(!it)return'';var m='';if(it.labels)m=String(it.labels).split(',')[0]||'';else if(it.ts)m='Recent';if(m.length>18)m=m.slice(0,18);return m;}function RI(it,i){var title=EH(it.title||'');var meta=MT(it);var h='<a class="gg-search__result gg-search-item" id="g'+i+'" role="option" data-i="'+i+'" href="'+EH(it.url||'')+'"><span class="gg-search__title">'+title+'</span>';if(meta)h+='<span class="gg-search__meta">'+EH(meta)+'</span>';h+='</a>';return h;}function RR(){var ui=UI();if(!ui)return;var r=GR(),list=[],html='',i=0;S.q='';if(r&&r.length){html+='<div class="gg-search__section">Recents</div>';for(var j=0;j<r.length&&j<5;j++){var it=r[j]||{};list.push(it);html+=RI(it,i++);}}if(!list.length){ui.panel.innerHTML='<div class="gg-search__hint">Type</div>';S.res=[];S.a=-1;ui.input&&ui.input.removeAttribute('aria-activedescendant');return;}ui.panel.innerHTML=html;S.res=list;S.a=-1;ui.input&&ui.input.removeAttribute('aria-activedescendant');}function SC(q){var rk=GG.modules&&GG.modules.searchRank&&GG.modules.searchRank.run;return typeof rk==='function'?rk(S.i,q,10):[];}function R(){try{var ui=UI();if(!ui)return;var q=(ui.input&&ui.input.value?ui.input.value:'').trim(),sr=GG.modules&&GG.modules.searchRank,p=sr&&sr.parse?sr.parse(q):0,m;if(!q){RR();return;}if(p&&p.s&&!p.f){ui.panel.innerHTML='<div class="gg-search__hint">/label</div>';S.res=[];S.a=-1;ui.input&&ui.input.removeAttribute('aria-activedescendant');return;}if(!S.r){IX().then(R).catch(function(){});return;}S.q=q.toLowerCase();S.res=SC(q)||[];S.a=-1;ui.input&&ui.input.removeAttribute('aria-activedescendant');m=sr&&sr.last?sr.last:0;if(!S.res.length){ui.panel.innerHTML='<div class="gg-search__hint">No local: "'+EH(q)+'"</div><div class="gg-search__hint">Enter/⌘↵ full</div>'+(m&&m.h?'<div class="gg-search__hint">'+EH(m.h)+'</div>':'');return;}var html='';if(m&&m.f)html+='<div class="gg-search__section">Filter·/'+EH(m.f)+'</div>';for(var i=0;i<S.res.length;i++)html+=RI(S.res[i]||{},i);html+='<div class="gg-search__hint">↵ open·⌘↵</div>';ui.panel.innerHTML=html;}catch(e){E(e,'');}}function SA(i){var ui=UI();if(!ui)return;var n=ui.panel.querySelectorAll('.gg-search-item');if(!n||!n.length){S.a=-1;ui.input&&ui.input.removeAttribute('aria-activedescendant');return;}if(i<0)i=0;if(i>=n.length)i=n.length-1;var p=S.a,el,x,t,sr=GG.modules&&GG.modules.searchRank;if(p>-1&&n[p]){n[p].removeAttribute('aria-selected');x=n[p].querySelector('.gg-search__title');if(x)x.textContent=(S.res[p]&&S.res[p].title)||'';}el=n[i];if(el){el.setAttribute('aria-selected','true');ui.input&&ui.input.setAttribute('aria-activedescendant',el.id||'');x=el.querySelector('.gg-search__title');if(x){t=(S.res[i]&&S.res[i].title)||'';if(sr&&sr.h)sr.h(x,t,S.q||'',d);else x.textContent=t;}}S.a=i;}function MA(dir){if(!S.res||!S.res.length)return;var i=S.a;if(i<0)i=dir>0?0:S.res.length-1;else{i=i+dir;if(i<0)i=S.res.length-1;else if(i>=S.res.length)i=0;}SA(i);}function PI(el){var i=parseInt(el.getAttribute('data-i'),10);if(!isNaN(i)&&S.res&&S.res[i])return S.res[i];return{url:el.getAttribute('href')||''};}function NAV(url,title){if(!url)return;var same=0,href=url;try{var u=new URL(url,w.location.href);if(u.origin===w.location.origin){same=1;href=u.pathname+u.search+u.hash;}else href=u.toString();}catch(_){}if(title)SR(href,title);X(1);if(same&&GG.core&&GG.core.router&&typeof GG.core.router.navigate==='function')GG.core.router.navigate(href);else w.location.assign(href);}function NI(it){if(!it)return;NAV(it.url||'',it.title||'');}function FS(){var ui=UI(),q=ui&&ui.input?ui.input.value.trim():'',sr=GG.modules&&GG.modules.searchRank,p=sr&&sr.parse?sr.parse(q):0,t=q;if(!q){X();return;}if(p&&p.s)t=p.r||p.f||'';if(!t){X();return;}X(1);w.location.assign('/search?q='+encodeURIComponent(t));}function IK(e){try{if(!e)return;if(e.key==='Escape'){e.preventDefault();X();return;}if(e.key==='Enter'&&(e.metaKey||e.ctrlKey)){e.preventDefault();FS();return;}if(e.key==='Enter'){e.preventDefault();if(S.a>-1&&S.res&&S.res[S.a])NI(S.res[S.a]);else FS();return;}if(e.key==='ArrowDown'||e.key==='ArrowUp'){e.preventDefault();MA(e.key==='ArrowDown'?1:-1);}}catch(x){var ui=UI(),q=ui&&ui.input?ui.input.value.trim():'';E(x,(e&&e.key==='Enter')?q:'');}}function OD(e){if(!S.o)return;var ui=UI(),t=e&&e.target;if(!ui||!t)return;if(ui.dock.contains(t)||ui.panel.contains(t))return;X(1);}function O(focusInput){try{var ui=UI();if(!ui)return;if(!S.o){S.o=1;S.f=d.activeElement;}ui.panel.hidden=false;ui.panel.setAttribute('aria-hidden','false');AP(ui.panel,ui);DS(1);R();IX().then(R).catch(function(){});if(focusInput)FD(ui);}catch(e){E(e,'');}}function X(skipRestore){var ui=UI();if(!ui)return;S.o=0;S.a=-1;ui.panel.hidden=true;ui.panel.setAttribute('aria-hidden','true');ui.input&&ui.input.removeAttribute('aria-activedescendant');Y();if(skipRestore)return;var last=S.f;S.f=null;if(last&&last.focus)try{last.focus();}catch(_){};}function init(){if(S.initd)return;S.initd=1;if(!UI())return;Y();if(w.__ggHotkeySearchPending||w.__GG_PENDING_SEARCH){w.__ggHotkeySearchPending=0;w.__GG_PENDING_SEARCH=false;O(1);}}return{init:init,open:O,close:X,openFromHotkey:function(){O(1);}};})();if(GG.boot&&GG.boot.onReady)GG.boot.onReady(function(){if(GG.modules&&GG.modules.search&&GG.modules.search.init)GG.modules.search.init();});})(w.GG=w.GG||{},w,document);})(window);
