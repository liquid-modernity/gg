(function(w){'use strict';var GG = w.GG = w.GG || {};GG.modules = GG.modules || {};GG.__uiBuckets = GG.__uiBuckets || {};if (GG.__uiBuckets.search) return;GG.__uiBuckets.search = true;(function(GG, w, d){'use strict';if (!GG) return;GG.modules = GG.modules || {};GG.modules.search = GG.modules.search || (function(){var state = {ready: false,loading: false,items: [],fuse: null,lastQuery: '',ttlMin: 60,ui: null,_init: false,_indexPromise: null,_libs: null,_o: false,_t: null,_f: null,_i: false,_ab: false};var KEY = 'gg_search_index_v1';function getCfg(){return (GG.store && GG.store.config) ? GG.store.config : {};}function getTTL(){var cfg = getCfg();var ttl = parseInt(cfg.searchCacheTTL, 10);return isNaN(ttl) || ttl <= 0 ? 60 : ttl;}function isTypingTarget(el){if (!el) return false;if (el.isContentEditable) return true;var tag = (el.tagName || '').toUpperCase();return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';}function importLibs(){if (state._libs) return state._libs;state._libs = Promise.all([import('https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.mjs'),import('https://unpkg.com/idb-keyval@6.2.1/dist/index.js')]).then(function(mods){var Fuse = mods[0] && (mods[0].default || mods[0].Fuse || mods[0]);var idb = mods[1] || {};return { Fuse: Fuse, idb: idb };});return state._libs;}function getStore(idb){if (idb && typeof idb.createStore === 'function') return idb.createStore('gg', 'search');return null;}function idbGet(idb, key){var store = getStore(idb);return store ? idb.get(key, store) : idb.get(key);}function idbSet(idb, key, val){var store = getStore(idb);return store ? idb.set(key, val, store) : idb.set(key, val);}function logError(stage, err){if (GG.core && typeof GG.core.telemetry === 'function') {GG.core.telemetry({type: 'search',stage: stage,message: err && err.message ? err.message : 'error'});}}function stripHtml(str){return String(str || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();}function pickAltLink(entry){var links = entry && entry.link ? entry.link : [];for (var i = 0; i < links.length; i++) {if (links[i].rel === 'alternate' && links[i].href) return links[i].href;}return '';}function parseFeed(json){var entries = (json && json.feed && json.feed.entry) ? json.feed.entry : [];var items = [];for (var i = 0; i < entries.length; i++) {var e = entries[i] || {};var title = (e.title && e.title.$t) ? e.title.$t : '';var url = pickAltLink(e);var summary = '';if (e.summary && e.summary.$t) summary = e.summary.$t;else if (e.content && e.content.$t) summary = e.content.$t;summary = stripHtml(summary);if (title && url) items.push({ title: title, url: url, summary: summary });}return items;}function buildFuse(Fuse, items){if (!Fuse) return null;return new Fuse(items || [], {keys: ['title', 'summary'],threshold: 0.35,ignoreLocation: true,minMatchCharLength: 2});}function ensureIndex(){if (state.ready) return Promise.resolve(state.items);if (state._indexPromise) return state._indexPromise;state._indexPromise = loadIndex().finally(function(){state._indexPromise = null;});return state._indexPromise;}async function loadIndex(){state.loading = true;state.ttlMin = getTTL();try {var libs = await importLibs();var idb = libs.idb || {};var Fuse = libs.Fuse;var cached = null;try { cached = await idbGet(idb, KEY); } catch (e) {}var ttlMs = state.ttlMin * 60 * 1000;if (cached && cached.ts && Array.isArray(cached.items) && (Date.now() - cached.ts) < ttlMs) {state.items = cached.items;state.fuse = buildFuse(Fuse, state.items);state.ready = true;state.loading = false;return state.items;}if (!GG.services || !GG.services.api || !GG.services.api.getFeed) {throw new Error('api-missing');}var json = await GG.services.api.getFeed({ summary: true, 'max-results': 500 });var items = parseFeed(json);state.items = items;state.fuse = buildFuse(Fuse, items);state.ready = true;state.loading = false;try { await idbSet(idb, KEY, { ts: Date.now(), items: items }); } catch (e2) {}return items;} catch (err) {state.loading = false;state.ready = false;logError('load', err);throw err;}}function ensureUI(){if (state.ui && state.ui.root) return state.ui;var host = d.getElementById('gg-dialog') || d.querySelector('.gg-dialog-host,[data-gg-ui="dialog"]');if (!host) return null;host.setAttribute('role', 'dialog');host.setAttribute('aria-modal', 'true');if (!host.getAttribute('aria-label') && !host.getAttribute('aria-labelledby')) {host.setAttribute('aria-label', 'Search');}if (!host.hasAttribute('tabindex')) host.setAttribute('tabindex', '-1');host.innerHTML = '' +'<div class="gg-search" data-gg-search-root>' +'<div class="gg-search__header">' +'<input class="gg-search__input" data-gg-search-input type="search" placeholder="Search..." aria-label="Search"/>' +'<button class="gg-search__close" data-gg-search-close type="button" aria-label="Close">Close</button>' +'</div>' +'<div class="gg-search__status" data-gg-search-status></div>' +'<div class="gg-search__results" data-gg-search-results role="listbox"></div>' +'</div>';var input = host.querySelector('[data-gg-search-input]');var results = host.querySelector('[data-gg-search-results]');var status = host.querySelector('[data-gg-search-status]');var closeBtn = host.querySelector('[data-gg-search-close]');state.ui = { root: host, input: input, results: results, status: status, close: closeBtn };if (input) {input.addEventListener('input', function(){state.lastQuery = input.value || '';renderResults();});input.addEventListener('keydown', function(e){if (e.key === 'Escape') {e.preventDefault();close();}if (e.key === 'Enter') {var first = state.ui && state.ui.results ? state.ui.results.querySelector('[data-gg-search-item]') : null;if (first) {e.preventDefault();navigate(first.getAttribute('href') || first.getAttribute('data-url'));}}});}if (results) {results.addEventListener('click', function(e){var item = e.target && e.target.closest ? e.target.closest('[data-gg-search-item]') : null;if (!item) return;e.preventDefault();navigate(item.getAttribute('href') || item.getAttribute('data-url'));});}if (closeBtn) {closeBtn.addEventListener('click', function(){close();});}host.addEventListener('keydown', function(e){if (!e) return;if (e.key === 'Escape') {e.preventDefault();close();}});return state.ui;}var DOCK_SEL = '#gg-dock,[data-gg-dock]';function dockVisible(el){if (!el || el.hasAttribute('hidden')) return false;var r = el.getBoundingClientRect();return !!(r && r.width > 0 && r.height > 0);}function applyAnchor(host){var dock = d.querySelector(DOCK_SEL);if (!dockVisible(dock)) {host.setAttribute('data-mode', 'center');return false;}var r = dock.getBoundingClientRect();host.style.setProperty('--gg-anchor-x', r.left + 'px');host.style.setProperty('--gg-anchor-y', r.top + 'px');host.style.setProperty('--gg-anchor-w', r.width + 'px');host.style.setProperty('--gg-anchor-h', r.height + 'px');host.setAttribute('data-mode', 'dock');return true;}function positionDialog(){var ui = ensureUI();if (!ui) return;applyAnchor(ui.root);}function bindAnchor(){if (state._ab) return;state._ab = true;var onResize = function(){if (!state._o) return;positionDialog();};w.addEventListener('resize', onResize);if (w.visualViewport && w.visualViewport.addEventListener) {w.visualViewport.addEventListener('resize', onResize);}}function setStatus(msg){if (!state.ui || !state.ui.status) return;state.ui.status.textContent = msg || '';state.ui.status.style.display = msg ? 'block' : 'none';}var _escNode = null;function escapeHtml(str){if (!d || !d.createElement) return String(str || '');if (!_escNode) _escNode = d.createElement('span');_escNode.textContent = String(str || '');return _escNode.innerHTML;}function nh(r){if (!r) return '';try{var u = new URL(r,w.location.href);if (u.origin === w.location.origin) return u.pathname + u.search + u.hash;return u.toString();}catch(e){ return r; }}function sb(){return d.querySelector('#gg-dock [data-gg-searchbar]') || d.querySelector('[data-gg-searchbar]');}function so(o){var t=d.documentElement;if(t&&t.classList)t.classList[o?'add':'remove']('gg-search-open');var b=sb();if(b)b.setAttribute('aria-hidden',o?'true':'false');}function renderResults(){var ui = ensureUI();if (!ui) return;var q = (ui.input && ui.input.value) ? ui.input.value.trim() : '';if (!q) {ui.results.innerHTML = '';setStatus('Type to search');return;}if (!state.ready) {setStatus('Loading search index…');ensureIndex().then(function(){ renderResults(); }).catch(function(){ setStatus('Search unavailable'); });return;}if (!state.fuse) {setStatus('Search unavailable');return;}var found = state.fuse.search(q, { limit: 12 });if (!found.length) {ui.results.innerHTML = '';setStatus('No results');return;}setStatus('');var html = found.map(function(res){var item = res && res.item ? res.item : {};var title = escapeHtml(item.title || '');var summary = escapeHtml(item.summary || '');var url = item.url || '';var href = escapeHtml(nh(url));return '' +'<a class="gg-search__result gg-search-item" data-gg-search-item href="' + href + '">' +'<span class="gg-search__title">' + title + '</span>' +(summary ? '<span class="gg-search__summary">' + summary + '</span>' : '') +'</a>';}).join('');ui.results.innerHTML = html;}function open(){var ui = ensureUI();if (!ui) return;if (state._o) {try { if (ui.input) ui.input.focus(); } catch (e) {}return;}state._o = true;state._f = d.activeElement;if (GG.ui && GG.ui.dialog && GG.ui.dialog.open) GG.ui.dialog.open();if (GG.ui && GG.ui.overlay && GG.ui.overlay.open) GG.ui.overlay.open();so(1);bindAnchor();positionDialog();if (GG.services && GG.services.a11y && GG.services.a11y.inertManager) {GG.services.a11y.inertManager.push(d.body, ui.root);state._i = true;}if (state._t) {try { state._t(); } catch (e) {}state._t = null;}if (GG.services && GG.services.a11y && GG.services.a11y.focusTrap) {state._t = GG.services.a11y.focusTrap(ui.root, { autofocus: false });}setStatus(state.ready ? '' : 'Loading search index…');ensureIndex().then(function(){setStatus('');renderResults();}).catch(function(){setStatus('Search unavailable');});try { if (ui.input) { ui.input.value = state.lastQuery || ''; ui.input.focus(); } } catch (e) {}}function close(){if (GG.ui && GG.ui.dialog && GG.ui.dialog.close) GG.ui.dialog.close();if (GG.ui && GG.ui.overlay && GG.ui.overlay.close) GG.ui.overlay.close();so(0);if (state._t) {try { state._t(); } catch (e) {}state._t = null;}if (state._i && GG.services && GG.services.a11y && GG.services.a11y.inertManager) {GG.services.a11y.inertManager.pop();}state._i = false;state._o = false;var last = state._f;state._f = null;if (last && last.focus) {try { last.focus(); } catch (e) {}}}function navigate(url){if (!url) return;var same = false;var href = url;try{var u = new URL(url, w.location.href);if (u.origin === w.location.origin) { same = true; href = u.pathname + u.search + u.hash; }else href = u.toString();}catch(e){}close();if (same && GG.core && GG.core.router && typeof GG.core.router.navigate === 'function') {GG.core.router.navigate(href);} else {w.location.assign(href);}}function onKeydown(e){if (!e) return;if (isTypingTarget(e.target)) return;var key = (e.key || '').toLowerCase();if ((e.ctrlKey || e.metaKey) && key === 'k') {e.preventDefault();open();}}function onClick(e){var target = e && e.target ? e.target : null;if (!target || !target.closest) return;var trigger = target.closest('[data-gg-search],.gg-search-trigger');if (!trigger) return;e.preventDefault();e.stopPropagation();open();}function bindTriggers(){d.addEventListener('keydown', onKeydown);d.addEventListener('click', onClick, true);}function warmIndex(){var run = function(){ensureIndex().catch(function(){});};if (w.requestIdleCallback) w.requestIdleCallback(run, { timeout: 2000 });else w.setTimeout(run, 1200);}function init(){if (state._init) return;state._init = true;state.ttlMin = getTTL();if (!(GG.modules && GG.modules.ui && GG.modules.ui._searchBound)) {bindTriggers();}warmIndex();}return { init: init, open: open, close: close };})();if (GG.boot && GG.boot.onReady) {GG.boot.onReady(function(){if (GG.modules && GG.modules.search && GG.modules.search.init) GG.modules.search.init();});}})(window.GG = window.GG || {}, window, document);})(window);