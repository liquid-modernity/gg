name: Perf Lighthouse (Live)

on:
  workflow_run:
    workflows: ["Deploy to Cloudflare Workers"]
    types: [completed]
  workflow_dispatch:
  schedule:
    # 02:30 Asia/Jakarta (UTC+7) == 19:30 UTC (previous day)
    - cron: "30 19 * * *"

concurrency:
  group: perf-lighthouse-main
  cancel-in-progress: false

jobs:
  lighthouse_live:
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout (workflow_dispatch/schedule)
        if: ${{ github.event_name != 'workflow_run' }}
        uses: actions/checkout@v4

      - name: Checkout (workflow_run head SHA)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run Lighthouse CI (with retries)
        run: |
          set -euo pipefail
          success=0
          for attempt in 1 2 3; do
            echo "LHCI attempt ${attempt}/3"
            rm -rf .lighthouseci
            if npx -y @lhci/cli@0.13.0 autorun --config=./lighthouse/lighthouserc.ci.js; then
              success=1
              break
            fi
            if [ "${attempt}" -lt 3 ]; then
              echo "LHCI failed, retrying in 20s..."
              sleep 20
            fi
          done
          if [ "${success}" -ne 1 ]; then
            echo "ERROR: Lighthouse CI failed after 3 attempts"
            exit 1
          fi

      - name: Optional temporary public storage links
        continue-on-error: true
        run: |
          set -euo pipefail
          npx -y @lhci/cli@0.13.0 upload --target=temporary-public-storage --inputDir=.lighthouseci \
            | tee .lighthouseci/temporary-public-storage.txt

      - name: Build LHCI summary
        run: node tools/perf/lhci-summary.mjs

      - name: Build LHCI trend artifact
        run: node tools/perf/lhci-trend.mjs

      - name: Stage LHCI artifacts
        run: |
          set -euo pipefail
          rm -rf lighthouseci-artifacts
          mkdir -p lighthouseci-artifacts
          if [ ! -d .lighthouseci ]; then
            echo "ERROR: missing .lighthouseci output directory"
            ls -la
            exit 1
          fi
          cp -R .lighthouseci/. lighthouseci-artifacts/
          if [ ! -f lighthouseci-artifacts/trend.json ]; then
            echo "ERROR: missing lighthouseci-artifacts/trend.json"
            ls -la lighthouseci-artifacts
            exit 1
          fi

      - name: Upload Lighthouse artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouseci-${{ github.run_id }}
          path: lighthouseci-artifacts
          if-no-files-found: error

      - name: Upload Lighthouse trend JSON
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-trend-${{ github.run_id }}
          path: lighthouseci-artifacts/trend.json
          if-no-files-found: error

      - name: Prepare perf-history worktree
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history"
          rm -rf "${HIST_DIR}"
          git fetch origin perf-history:perf-history || true
          if git show-ref --verify --quiet refs/heads/perf-history; then
            git worktree add "${HIST_DIR}" perf-history
          else
            git worktree add "${HIST_DIR}" HEAD
            (
              cd "${HIST_DIR}"
              git checkout --orphan perf-history
              git rm -rf . >/dev/null 2>&1 || true
            )
          fi
          mkdir -p "${HIST_DIR}/perf"
          touch "${HIST_DIR}/perf/history.ndjson"

      - name: Append perf-history record and rebuild dashboard
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history"
          cp lighthouseci-artifacts/trend.json "${HIST_DIR}/.trend.json"
          before_lines="$(wc -l < "${HIST_DIR}/perf/history.ndjson" | tr -d ' ')"
          node tools/perf/perf-history-append.mjs --trend "${HIST_DIR}/.trend.json" --out "${HIST_DIR}/.rec.json"
          cat "${HIST_DIR}/.rec.json" >> "${HIST_DIR}/perf/history.ndjson"
          echo >> "${HIST_DIR}/perf/history.ndjson"
          after_lines="$(wc -l < "${HIST_DIR}/perf/history.ndjson" | tr -d ' ')"
          if [ "${after_lines}" -le "${before_lines}" ]; then
            echo "ERROR: perf/history.ndjson did not grow"
            exit 1
          fi
          node tools/perf/perf-history-build.mjs --root "${HIST_DIR}"

      - name: Commit and push perf-history branch
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history"
          cd "${HIST_DIR}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add perf/history.ndjson perf/latest.json perf/index.html
          if git diff --cached --quiet; then
            echo "No perf-history changes to commit"
            exit 0
          fi
          short_sha="${GITHUB_SHA::7}"
          git commit -m "perf(history): append ${short_sha} run ${GITHUB_RUN_ID}"
          git push origin perf-history

      - name: Perf dashboard pointers
        if: always()
        run: |
          set -euo pipefail
          DASHBOARD_URL="${PERF_DASHBOARD_URL:-XXX}"
          REPO_FULL="${GITHUB_REPOSITORY:-owner/repo}"
          OWNER="${REPO_FULL%%/*}"
          REPO="${REPO_FULL##*/}"
          {
            echo "### Perf Dashboard Pointers"
            if [ "${DASHBOARD_URL}" = "XXX" ]; then
              echo "- Perf dashboard: XXX"
              echo "- Set GitHub Pages source to branch \`perf-history\` folder \`/(root)\`."
              echo "- Expected project URL: https://${OWNER}.github.io/${REPO}/perf/index.html"
            else
              echo "- Perf dashboard: ${DASHBOARD_URL}"
            fi
            echo "- Latest snapshot: perf-history/perf/latest.json"
            echo "- History log: perf-history/perf/history.ndjson"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Cleanup perf-history worktree
        if: always()
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history"
          git worktree remove "${HIST_DIR}" --force || true
