name: Perf History Bootstrap

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: perf-history-bootstrap
  cancel-in-progress: true

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap perf-history branch
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history-bootstrap"
          rm -rf "${HIST_DIR}"

          git fetch origin perf-history:perf-history || true
          if git show-ref --verify --quiet refs/heads/perf-history; then
            git worktree add "${HIST_DIR}" perf-history
          else
            git worktree add "${HIST_DIR}" HEAD
            (
              cd "${HIST_DIR}"
              git checkout --orphan perf-history
              git rm -rf . >/dev/null 2>&1 || true
            )
          fi

          mkdir -p "${HIST_DIR}/perf"
          [ -f "${HIST_DIR}/perf/history.ndjson" ] || : > "${HIST_DIR}/perf/history.ndjson"
          [ -f "${HIST_DIR}/perf/latest.json" ] || printf '{}\n' > "${HIST_DIR}/perf/latest.json"
          if [ ! -f "${HIST_DIR}/perf/index.html" ]; then
            cat <<'HTML' > "${HIST_DIR}/perf/index.html"
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Perf History</title>
          </head>
          <body>
            <h1>Perf History</h1>
            <p>Dashboard will be generated by perf-lighthouse workflow.</p>
          </body>
          </html>
          HTML
          fi

          cd "${HIST_DIR}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add perf/history.ndjson perf/latest.json perf/index.html
          if git diff --cached --quiet; then
            echo "No bootstrap changes to commit"
          else
            git commit -m "chore(perf): bootstrap perf-history branch"
          fi
          git push origin perf-history

      - name: Perf dashboard pointers
        if: always()
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY#*/}"
          {
            echo "### Perf History Bootstrap"
            echo "- Branch ready: \`perf-history\`"
            echo "- Set GitHub Pages Source: branch \`perf-history\`, folder \`/(root)\`"
            echo "- Dashboard URL: https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO}/perf/index.html"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Cleanup worktree
        if: always()
        run: |
          set -euo pipefail
          HIST_DIR="${RUNNER_TEMP}/perf-history-bootstrap"
          git worktree remove "${HIST_DIR}" --force || true
