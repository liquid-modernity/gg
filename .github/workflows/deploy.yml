name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      RUN_SMOKE:
        description: "Run post-deploy smoke test"
        required: false
        default: "false"

concurrency:
  group: workers-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight static assets
        run: |
          set -e
          if [ ! -f public/sw.js ]; then
            echo "ERROR: public/sw.js missing"
            exit 1
          fi
          if [ ! -f public/manifest.webmanifest ]; then
            echo "ERROR: public/manifest.webmanifest missing"
            exit 1
          fi
          if [ ! -f public/offline.html ]; then
            echo "ERROR: public/offline.html missing"
            exit 1
          fi
          if [ ! -f public/_headers ]; then
            echo "ERROR: public/_headers missing"
            exit 1
          fi
          rel="$(grep -oE '/assets/v/[A-Za-z0-9._-]+' index.prod.xml | head -n 1 | sed -E 's#/assets/v/##')"
          if [ -z "${rel}" ]; then
            echo "ERROR: release id not found in index.prod.xml"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.css" ]; then
            echo "ERROR: public/assets/v/${rel}/main.css missing"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.js" ]; then
            echo "ERROR: public/assets/v/${rel}/main.js missing"
            exit 1
          fi
          echo "ls -la public | head"
          ls -la public | head
          echo "public/_headers (first 120 lines)"
          sed -n '1,120p' public/_headers

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify Cloudflare token
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          resp="$(curl -sS -H "Authorization: Bearer ${CF_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/tokens/verify")"
          echo "${resp}" | head -c 2000
          if ! echo "${resp}" | grep -q '"success":[[:space:]]*true'; then
            echo "ERROR: token verify failed"
            exit 1
          fi

      - name: Route audit (zone workers/routes)
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -e
          if [ -z "${CF_ZONE_ID}" ]; then
            echo "ERROR: CLOUDFLARE_ZONE_ID secret is missing or empty"
            exit 1
          fi
          echo "ZONE_ID=${CF_ZONE_ID}"

          echo "Fetch workers/routes"
          ROUTES_JSON="$(curl -sS -H "Authorization: Bearer ${CF_TOKEN}" "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/workers/routes")"
          echo "$ROUTES_JSON" | head -c 2000
          python3 - <<'PY'
          import json,sys
          txt=sys.stdin.read().strip()
          if not txt:
            print("ERROR: workers/routes empty response")
            sys.exit(1)
          try:
            data=json.loads(txt)
          except Exception as e:
            print("ERROR: workers/routes invalid JSON:", e)
            sys.exit(1)
          if not data.get("success"):
            print("ERROR: workers/routes failed:", data.get("errors"))
            print("HINT: ensure token has Zone:Workers Routes:Read permissions")
            sys.exit(1)
          print("routes_ok")
          PY
          <<<"$ROUTES_JSON"

          echo "Extract patterns => script"
          printf "%s" "$ROUTES_JSON" | python3 - <<'PY'
          import sys, json
          data=json.load(sys.stdin)
          print("success:", data.get("success"))
          for r in data.get("result", []):
              print(r.get("pattern"), "=>", r.get("script"))
          PY

          echo "Assert wildcard routes exist"
          printf "%s" "$ROUTES_JSON" | python3 - <<'PY'
          import sys, json
          data=json.load(sys.stdin)
          patterns={r.get("pattern") for r in data.get("result", [])}
          required=("www.pakrpp.com/*",)
          missing=[p for p in required if p not in patterns]
          if missing:
            print("ERROR: missing wildcard routes:", ", ".join(missing))
            sys.exit(1)
          print("wildcard_routes_ok")
          PY

      - name: Publish Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.61.1"
          command: deploy --config wrangler.jsonc

      - name: Post-deploy smoke test
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.RUN_SMOKE == 'true' }}
        run: |
          set -e
          check_status() {
            local url="$1"
            local label="$2"
            local headers status_line
            headers="$(curl -sSI "${url}")"
            status_line="$(printf "%s" "${headers}" | head -n 1)"
            echo "==> ${label}"
            echo "${status_line}"
            if ! echo "${status_line}" | grep -q " 200"; then
              echo "ERROR: ${label} non-200 response"
              exit 1
            fi
            printf "%s" "${headers}"
          }

          headers="$(check_status "https://www.pakrpp.com/__gg_worker_ping?x=1" "__gg_worker_ping")"
          if ! echo "${headers}" | grep -qi '^x-gg-worker-version:'; then
            echo "ERROR: missing x-gg-worker-version header"
            exit 1
          fi

          headers="$(check_status "https://www.pakrpp.com/gg-flags.json?x=1" "gg-flags.json")"
          if ! echo "${headers}" | grep -qi '^content-type:.*json'; then
            echo "ERROR: gg-flags.json must be json content-type"
            exit 1
          fi
          if ! echo "${headers}" | grep -qi '^cache-control:.*no-store'; then
            echo "ERROR: gg-flags.json must be no-store"
            exit 1
          fi

          headers="$(check_status "https://www.pakrpp.com/blog" "/blog")"
          echo "${headers}" >/dev/null

          headers="$(check_status "https://www.pakrpp.com/sw.js?x=1" "sw.js")"
          if ! echo "${headers}" | grep -qi '^cache-control:.*no-store'; then
            echo "ERROR: sw.js must be no-store"
            exit 1
          fi

          headers="$(check_status "https://www.pakrpp.com/manifest.webmanifest" "manifest")"
          if ! echo "${headers}" | grep -qi '^x-gg-worker:'; then
            echo "ERROR: missing x-gg-worker header"
            exit 1
          fi

          headers="$(check_status "https://www.pakrpp.com/offline.html" "offline")"
          if ! echo "${headers}" | grep -qi '^x-gg-worker:'; then
            echo "ERROR: missing x-gg-worker header"
            exit 1
          fi
