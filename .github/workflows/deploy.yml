name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      sha:
        description: Commit SHA to deploy (must have green CI)
        required: true
        type: string

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Validate deploy SHA
        run: |
          set -e
          if [ -z "${{ inputs.sha }}" ]; then
            echo "ERROR: inputs.sha is required"
            exit 1
          fi

      - name: Verify CI success for SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ inputs.sha }}
        run: |
          set -e
          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          token = os.environ.get("GH_TOKEN", "").strip()
          repo = os.environ.get("REPO", "").strip()
          sha = os.environ.get("SHA", "").strip()

          if not sha:
              print("ERROR: inputs.sha is required")
              sys.exit(1)

          url = f"https://api.github.com/repos/{repo}/actions/workflows/ci.yml/runs?head_sha={sha}&status=success&per_page=1"
          req = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
              },
          )
          try:
              with urllib.request.urlopen(req, timeout=20) as resp:
                  data = json.loads(resp.read().decode("utf-8", "replace"))
          except Exception as e:
              print("ERROR: failed to query CI workflow runs:", e)
              sys.exit(1)

          runs = data.get("workflow_runs", [])
          ok = any(r.get("head_sha") == sha and r.get("conclusion") == "success" for r in runs)
          if not ok:
              print(f"ERROR: No successful CI run found for sha {sha}")
              sys.exit(1)
          print(f"CI_SUCCESS_OK {sha}")
          PY

      - name: Checkout (pinned SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Guard lockfile
        run: |
          set -e
          if [ ! -f package-lock.json ]; then
            echo "ERROR: package-lock.json is required. Run npm install --package-lock-only --ignore-scripts and commit it."
            exit 1
          fi

      - name: Preflight (build + verifiers)
        run: |
          set -e
          npm ci
          npm run build
          npm run verify:assets
          npm run verify:xml
          if [ -f tools/verify-theme-diff.mjs ]; then
            node tools/verify-theme-diff.mjs
          else
            echo "SKIP: tools/verify-theme-diff.mjs not found"
          fi
          if [ -f tools/check-links.sh ]; then
            bash tools/check-links.sh
          else
            echo "SKIP: tools/check-links.sh not found"
          fi

      # Preflight verifiers apply to both workflow_run and workflow_dispatch.
      - name: Verify ledger + doc contracts
        run: node tools/verify-ledger.mjs
        
      - name: Verify router contract
        run: node tools/verify-router-contract.mjs

      - name: Verify performance budgets
        run: node tools/verify-budgets.mjs

      - name: Verify inline CSS budget
        run: node tools/verify-inline-css.mjs

      - name: Verify CRP regressions
        run: node tools/verify-crp.mjs

      - name: Verify headers contract (config)
        run: node tools/verify-headers.mjs --mode=config

      - name: Verify build determinism
        run: |
          set -e
          if ! git diff --exit-code; then
            echo "Build produced changes. Run npm run build locally and commit generated artifacts."
            exit 1
          fi
          if [ -n "$(git status --porcelain)" ]; then
            echo "Build produced changes. Run npm run build locally and commit generated artifacts."
            git status --porcelain
            exit 1
          fi

      - name: Preflight static assets + release id
        id: rel
        run: |
          set -e
          if [ ! -f public/sw.js ]; then
            echo "ERROR: public/sw.js missing"
            exit 1
          fi
          if [ ! -f public/manifest.webmanifest ]; then
            echo "ERROR: public/manifest.webmanifest missing"
            exit 1
          fi
          if [ ! -f public/offline.html ]; then
            echo "ERROR: public/offline.html missing"
            exit 1
          fi
          if [ ! -f public/_headers ]; then
            echo "ERROR: public/_headers missing"
            exit 1
          fi
          rel="$(grep -oE '/assets/v/[A-Za-z0-9._-]+' index.prod.xml | head -n 1 | sed -E 's#/assets/v/##')"
          if [ -z "${rel}" ]; then
            echo "ERROR: release id not found in index.prod.xml"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.css" ]; then
            echo "ERROR: public/assets/v/${rel}/main.css missing"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.js" ]; then
            echo "ERROR: public/assets/v/${rel}/main.js missing"
            exit 1
          fi
          echo "release_id=${rel}" >> "$GITHUB_OUTPUT"
          echo "ls -la public | head"
          ls -la public | head
          echo "public/_headers (first 120 lines)"
          sed -n '1,120p' public/_headers

      - name: Verify Cloudflare token
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          resp="$(curl -sS -H "Authorization: Bearer ${CF_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/tokens/verify")"
          echo "${resp}" | head -c 2000
          if ! echo "${resp}" | grep -q '"success":[[:space:]]*true'; then
            echo "ERROR: token verify failed"
            exit 1
          fi

      - name: Route audit (zone workers/routes)
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |-
          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          zone_id = os.environ.get("CF_ZONE_ID", "").strip()
          token = os.environ.get("CF_TOKEN", "").strip()

          if not zone_id:
              print("ERROR: CLOUDFLARE_ZONE_ID secret is missing or empty")
              sys.exit(1)

          url = f"https://api.cloudflare.com/client/v4/zones/{zone_id}/workers/routes"
          req = urllib.request.Request(url, headers={"Authorization": f"Bearer {token}"})
          print(f"ZONE_ID={zone_id}")
          print("Fetch workers/routes")
          try:
              with urllib.request.urlopen(req, timeout=20) as resp:
                  txt = resp.read().decode("utf-8", "replace")
          except Exception as e:
              print("ERROR: workers/routes request failed:", e)
              sys.exit(1)

          print(txt[:2000])

          if not txt.strip():
              print("ERROR: workers/routes empty response")
              sys.exit(1)
          try:
              data = json.loads(txt)
          except Exception as e:
              print("ERROR: workers/routes invalid JSON:", e)
              sys.exit(1)
          if not data.get("success"):
              print("ERROR: workers/routes failed:", data.get("errors"))
              print("HINT: ensure token has Zone:Workers Routes:Read permissions")
              sys.exit(1)

          print("Extract patterns => script")
          for r in data.get("result", []):
              print(f"{r.get('pattern')} => {r.get('script')}")

          patterns = {r.get("pattern") for r in data.get("result", [])}
          required = {"www.pakrpp.com/*"}
          missing = sorted(required - patterns)
          if missing:
              print("ERROR: missing wildcard routes:", ", ".join(missing))
              sys.exit(1)

          print("wildcard_routes_ok")
          PY

      
      - name: Publish Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.61.1"
          command: deploy --config wrangler.jsonc

      - name: Verify headers contract (live)
        run: node tools/verify-headers.mjs --mode=live --base=https://www.pakrpp.com

      - name: Post-deploy smoke tests
        env:
          REL: ${{ steps.rel.outputs.release_id }}
        run: |
          set -euo pipefail

          BASE="https://www.pakrpp.com"
          APEX="https://pakrpp.com"

          fetch_headers() {
            curl -sSI "$1" | tr -d '\r'
          }

          status_code() {
            printf "%s" "$1" | head -n 1 | awk '{print $2}'
          }

          require_status() {
            local url="$1"
            local expected="$2"
            local label="$3"
            local headers code
            headers="$(fetch_headers "$url")"
            code="$(status_code "$headers")"
            echo "==> ${label} (${url})"
            echo "${headers}" | head -n 1
            if [ "${code}" != "${expected}" ]; then
              echo "ERROR: ${label} expected ${expected}, got ${code}"
              exit 1
            fi
            printf "%s" "$headers"
          }

          require_header() {
            local headers="$1"
            local pattern="$2"
            local label="$3"
            if ! printf "%s" "$headers" | grep -Eqi "$pattern"; then
              echo "ERROR: ${label}"
              exit 1
            fi
          }

          apex_headers="$(fetch_headers "${APEX}/?x=1")"
          apex_code="$(status_code "$apex_headers")"
          echo "==> apex redirect (${APEX})"
          echo "${apex_headers}" | head -n 1
          if [ "${apex_code}" != "301" ]; then
            echo "ERROR: apex must return 301"
            exit 1
          fi
          require_header "$apex_headers" '^location: https://www\.pakrpp\.com/' "apex must redirect to www"

          ping_headers="$(require_status "${BASE}/__gg_worker_ping?x=1" "200" "__gg_worker_ping")"
          require_header "$ping_headers" '^x-gg-worker-version:' "missing x-gg-worker-version"

          flags_headers="$(require_status "${BASE}/gg-flags.json?x=1" "200" "gg-flags.json")"
          require_header "$flags_headers" '^cache-control:.*(no-store|max-age=0)' "gg-flags.json must be no-store"

          sw_headers="$(require_status "${BASE}/sw.js?x=1" "200" "sw.js")"
          require_header "$sw_headers" '^cache-control:.*(no-store|max-age=0)' "sw.js must be no-store"

          latest_headers="$(require_status "${BASE}/assets/latest/main.js?x=1" "200" "assets/latest/main.js")"
          require_header "$latest_headers" '^cache-control:.*(no-store|max-age=0)' "assets/latest must be no-store"

          if [ -z "${REL}" ]; then
            echo "ERROR: release id missing from preflight"
            exit 1
          fi
          pinned_headers="$(require_status "${BASE}/assets/v/${REL}/main.js?x=1" "200" "assets/v/${REL}/main.js")"
          require_header "$pinned_headers" '^cache-control:.*immutable' "assets/v must be immutable"

          require_status "${BASE}/offline.html?x=1" "200" "offline.html"

          echo "PASS: smoke tests"
