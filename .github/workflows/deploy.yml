name: Deploy to Cloudflare Workers

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout (workflow_run)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Assert manual dispatch on main
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          set -e
          if [ "${GITHUB_REF_NAME}" != "main" ]; then
            echo "ERROR: manual dispatch must run from main (got ${GITHUB_REF_NAME})"
            exit 1
          fi

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Preflight (build + verifiers)
        run: |
          set -e
          npm ci
          npm run build
          npm run verify:assets
          npm run build:xml
          npm run verify:xml
          if [ -f tools/verify-theme-diff.mjs ]; then
            node tools/verify-theme-diff.mjs
          else
            echo "SKIP: tools/verify-theme-diff.mjs not found"
          fi
          if [ -f tools/check-links.sh ]; then
            bash tools/check-links.sh
          else
            echo "SKIP: tools/check-links.sh not found"
          fi

      - name: Preflight static assets + release id
        id: rel
        run: |
          set -e
          if [ ! -f public/sw.js ]; then
            echo "ERROR: public/sw.js missing"
            exit 1
          fi
          if [ ! -f public/manifest.webmanifest ]; then
            echo "ERROR: public/manifest.webmanifest missing"
            exit 1
          fi
          if [ ! -f public/offline.html ]; then
            echo "ERROR: public/offline.html missing"
            exit 1
          fi
          if [ ! -f public/_headers ]; then
            echo "ERROR: public/_headers missing"
            exit 1
          fi
          rel="$(grep -oE '/assets/v/[A-Za-z0-9._-]+' index.prod.xml | head -n 1 | sed -E 's#/assets/v/##')"
          if [ -z "${rel}" ]; then
            echo "ERROR: release id not found in index.prod.xml"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.css" ]; then
            echo "ERROR: public/assets/v/${rel}/main.css missing"
            exit 1
          fi
          if [ ! -f "public/assets/v/${rel}/main.js" ]; then
            echo "ERROR: public/assets/v/${rel}/main.js missing"
            exit 1
          fi
          echo "release_id=${rel}" >> "$GITHUB_OUTPUT"
          echo "ls -la public | head"
          ls -la public | head
          echo "public/_headers (first 120 lines)"
          sed -n '1,120p' public/_headers

      - name: Verify Cloudflare token
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -e
          resp="$(curl -sS -H "Authorization: Bearer ${CF_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/tokens/verify")"
          echo "${resp}" | head -c 2000
          if ! echo "${resp}" | grep -q '"success":[[:space:]]*true'; then
            echo "ERROR: token verify failed"
            exit 1
          fi

      - name: Route audit (zone workers/routes)
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -e
          if [ -z "${CF_ZONE_ID}" ]; then
            echo "ERROR: CLOUDFLARE_ZONE_ID secret is missing or empty"
            exit 1
          fi
          echo "ZONE_ID=${CF_ZONE_ID}"

          echo "Fetch workers/routes"
          ROUTES_JSON="$(curl -sS -H "Authorization: Bearer ${CF_TOKEN}" "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/workers/routes")"
          echo "$ROUTES_JSON" | head -c 2000
          printf '%s' "$ROUTES_JSON" | python3 -c $'import json,sys\n\
txt=sys.stdin.read().strip()\n\
if not txt:\n\
  print("ERROR: workers/routes empty response")\n\
  sys.exit(1)\n\
try:\n\
  data=json.loads(txt)\n\
except Exception as e:\n\
  print("ERROR: workers/routes invalid JSON:", e)\n\
  sys.exit(1)\n\
if not data.get("success"):\n\
  print("ERROR: workers/routes failed:", data.get("errors"))\n\
  print("HINT: ensure token has Zone:Workers Routes:Read permissions")\n\
  sys.exit(1)\n\
print("routes_ok")'

          echo "Extract patterns => script"
          printf "%s" "$ROUTES_JSON" | python3 -c $'import sys, json\n\
data=json.load(sys.stdin)\n\
print("success:", data.get("success"))\n\
for r in data.get("result", []):\n\
  print(r.get("pattern"), "=>", r.get("script"))'

          echo "Assert wildcard routes exist"
          printf "%s" "$ROUTES_JSON" | python3 -c $'import sys, json\n\
data=json.load(sys.stdin)\n\
patterns={r.get("pattern") for r in data.get("result", [])}\n\
required=("www.pakrpp.com/*",)\n\
missing=[p for p in required if p not in patterns]\n\
if missing:\n\
  print("ERROR: missing wildcard routes:", ", ".join(missing))\n\
  sys.exit(1)\n\
print("wildcard_routes_ok")'

      - name: Publish Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.61.1"
          command: deploy --config wrangler.jsonc

      - name: Post-deploy smoke tests
        env:
          REL: ${{ steps.rel.outputs.release_id }}
        run: |
          set -euo pipefail

          BASE="https://www.pakrpp.com"
          APEX="https://pakrpp.com"

          fetch_headers() {
            curl -sSI "$1" | tr -d '\r'
          }

          status_code() {
            printf "%s" "$1" | head -n 1 | awk '{print $2}'
          }

          require_status() {
            local url="$1"
            local expected="$2"
            local label="$3"
            local headers code
            headers="$(fetch_headers "$url")"
            code="$(status_code "$headers")"
            echo "==> ${label} (${url})"
            echo "${headers}" | head -n 1
            if [ "${code}" != "${expected}" ]; then
              echo "ERROR: ${label} expected ${expected}, got ${code}"
              exit 1
            fi
            printf "%s" "$headers"
          }

          require_header() {
            local headers="$1"
            local pattern="$2"
            local label="$3"
            if ! printf "%s" "$headers" | grep -Eqi "$pattern"; then
              echo "ERROR: ${label}"
              exit 1
            fi
          }

          apex_headers="$(fetch_headers "${APEX}/?x=1")"
          apex_code="$(status_code "$apex_headers")"
          echo "==> apex redirect (${APEX})"
          echo "${apex_headers}" | head -n 1
          if [ "${apex_code}" != "301" ]; then
            echo "ERROR: apex must return 301"
            exit 1
          fi
          require_header "$apex_headers" '^location: https://www\.pakrpp\.com/' "apex must redirect to www"

          ping_headers="$(require_status "${BASE}/__gg_worker_ping?x=1" "200" "__gg_worker_ping")"
          require_header "$ping_headers" '^x-gg-worker-version:' "missing x-gg-worker-version"

          flags_headers="$(require_status "${BASE}/gg-flags.json?x=1" "200" "gg-flags.json")"
          require_header "$flags_headers" '^cache-control:.*(no-store|max-age=0)' "gg-flags.json must be no-store"

          sw_headers="$(require_status "${BASE}/sw.js?x=1" "200" "sw.js")"
          require_header "$sw_headers" '^cache-control:.*(no-store|max-age=0)' "sw.js must be no-store"

          latest_headers="$(require_status "${BASE}/assets/latest/main.js?x=1" "200" "assets/latest/main.js")"
          require_header "$latest_headers" '^cache-control:.*(no-store|max-age=0)' "assets/latest must be no-store"

          if [ -z "${REL}" ]; then
            echo "ERROR: release id missing from preflight"
            exit 1
          fi
          pinned_headers="$(require_status "${BASE}/assets/v/${REL}/main.js?x=1" "200" "assets/v/${REL}/main.js")"
          require_header "$pinned_headers" '^cache-control:.*immutable' "assets/v must be immutable"

          require_status "${BASE}/offline.html?x=1" "200" "offline.html"

          echo "PASS: smoke tests"
