name: Deploy to Cloudflare Workers

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          - name: Verify Cloudflare token can see this account
          run: |
            python - << 'PY'
            import os, json, urllib.request
            token = os.environ["CF_TOKEN"]
            req = urllib.request.Request(
              "https://api.cloudflare.com/client/v4/accounts",
              headers={"Authorization": f"Bearer {token}"}
            )
            data = json.loads(urllib.request.urlopen(req).read().decode())
            print("success:", data.get("success"))
            # print only account IDs (not secret)
            ids = [a["id"] for a in data.get("result", [])]
            print("accounts_visible_count:", len(ids))
            print("visible_account_ids:", ids)
            PY
          env:
            CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  
      - name: Publish Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "3.99.0"
          command: deploy