name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight static assets
        run: |
          set -e
          if [ ! -f public/sw.js ]; then
            echo "ERROR: public/sw.js missing"
            exit 1
          fi
          if [ ! -f public/_headers ]; then
            echo "ERROR: public/_headers missing"
            exit 1
          fi
          echo "ls -la public | head"
          ls -la public | head
          echo "public/_headers (first 120 lines)"
          sed -n '1,120p' public/_headers

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate Cloudflare account and zone ownership
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          python3 - <<'PY'
          import os, json, sys, urllib.request, urllib.parse

          token = os.environ["CF_TOKEN"]
          expected_account_id = os.environ["CF_ACCOUNT_ID"]

          def cf_get(url):
              req = urllib.request.Request(
                  url,
                  headers={"Authorization": f"Bearer {token}"}
              )
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode())

          # 1) accountId must be visible to token
          accounts = cf_get("https://api.cloudflare.com/client/v4/accounts")
          if not accounts.get("success"):
              print("accounts_errors:", accounts.get("errors"))
              sys.exit(1)

          account_ids = [a.get("id") for a in accounts.get("result", [])]
          if expected_account_id not in account_ids:
              print("provided_account_id_secret:", expected_account_id)
              print("visible_account_ids:", account_ids)
              print("ERROR: CLOUDFLARE_ACCOUNT_ID is not visible to this token")
              sys.exit(1)

          # 2) zone pakrpp.com must exist and be owned by that accountId
          zones_url = "https://api.cloudflare.com/client/v4/zones?name=" + urllib.parse.quote("pakrpp.com")
          zones = cf_get(zones_url)
          if not zones.get("success"):
              print("zones_errors:", zones.get("errors"))
              sys.exit(1)

          results = zones.get("result", [])
          if not results:
              print("ERROR: zone pakrpp.com not found for this token")
              sys.exit(1)

          zone_account_id = results[0].get("account", {}).get("id")
          print("expected_account_id_from_zone:", zone_account_id)
          print("provided_account_id_secret:", expected_account_id)

          if zone_account_id != expected_account_id:
              print("ERROR: CLOUDFLARE_ACCOUNT_ID does not own zone pakrpp.com")
              sys.exit(1)

          print("validation_ok")
          PY

      - name: Publish Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.61.1"
          command: deploy --config wrangler.jsonc

      - name: Verify token (Cloudflare endpoint)
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          curl -sS -H "Authorization: Bearer ${CF_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/tokens/verify" | head -c 2000
