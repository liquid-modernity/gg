name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Guard lockfile
        run: |
          set -e
          if [ ! -f package-lock.json ]; then
            echo "ERROR: package-lock.json is required. Run npm install --package-lock-only --ignore-scripts and commit it."
            exit 1
          fi

      - name: Install deps (npm ci)
        run: |
          set -e
          npm ci

      - name: Verify release aligned (fast fail)
        run: |
          set -e
          if ! node tools/verify-release-aligned.mjs; then
            echo "Release not aligned to HEAD. Run npm run prep:release and commit artifacts."
            exit 1
          fi

      - name: Build + verifiers
        run: |
          set -e
          npm run build
          npm run verify:assets
          npm run verify:xml
          if [ -f tools/verify-theme-diff.mjs ]; then
            node tools/verify-theme-diff.mjs
          else
            echo "SKIP: tools/verify-theme-diff.mjs not found"
          fi
          if [ -f tools/check-links.sh ]; then
            bash tools/check-links.sh
          else
            echo "SKIP: tools/check-links.sh not found"
          fi

      - name: Verify ledger + doc contracts
        run: node tools/verify-ledger.mjs

      - name: Verify router contract
        run: node tools/verify-router-contract.mjs

      - name: Verify headers contract (config)
        run: node tools/verify-headers.mjs --mode=config

      - name: Verify performance budgets
        run: node tools/verify-budgets.mjs

      - name: Verify inline CSS budget
        run: node tools/verify-inline-css.mjs

      - name: Verify CRP regressions
        run: node tools/verify-crp.mjs

      - name: Verify build determinism
        run: |
          set -e
          if ! git diff --exit-code; then
            echo "Build produced changes. Run npm run build locally and commit generated artifacts."
            exit 1
          fi
          if [ -n "$(git status --porcelain)" ]; then
            echo "Build produced changes. Run npm run build locally and commit generated artifacts."
            git status --porcelain
            exit 1
          fi

      - name: XML well-formedness
        run: |
          set -e
          if command -v xmllint >/dev/null 2>&1; then
            xmllint --noout index.dev.xml
            xmllint --noout index.prod.xml
          else
            node tools/validate-xml.js
          fi

  trigger_deploy:
    needs: ci
    if: ${{ success() && github.ref_name == 'main' }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Dispatch deploy workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -e
          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/actions/workflows/deploy.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"sha\":\"${SHA}\"}}"
