name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Guard lockfile
        run: |
          set -e
          if [ ! -f package-lock.json ]; then
            echo "ERROR: package-lock.json is required. Run npm install --package-lock-only --ignore-scripts and commit it."
            exit 1
          fi

      - name: Install deps (npm ci)
        run: |
          set -e
          npm ci

      - name: Build + verifiers
        run: |
          set -e
          npm run build
          npm run verify:assets
          npm run build:xml
          npm run verify:xml
          if [ -f tools/verify-theme-diff.mjs ]; then
            node tools/verify-theme-diff.mjs
          else
            echo "SKIP: tools/verify-theme-diff.mjs not found"
          fi
          if [ -f tools/check-links.sh ]; then
            bash tools/check-links.sh
          else
            echo "SKIP: tools/check-links.sh not found"
          fi

      - name: Verify ledger sync
        run: node tools/verify-ledger.mjs

      - name: XML well-formedness
        run: |
          set -e
          if command -v xmllint >/dev/null 2>&1; then
            xmllint --noout index.dev.xml
            xmllint --noout index.prod.xml
          else
            node tools/validate-xml.js
          fi
